"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@transmute/linked-data-proof"),t=e(require("jsonld")),n=require("jsonld-checker"),i=e(require("moment"));function o(){return(o=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function a(e,r){e.prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r}var s=function(){function e(e){var r=void 0===e?{}:e,t=r.term,n=r.date,i=r.maxTimestampDelta,o=void 0===i?Infinity:i;if(void 0===t)throw new Error('"term" is required.');if(void 0!==o&&"number"!=typeof o)throw new TypeError('"maxTimestampDelta" must be a number.');if(this.term=t,void 0!==n&&(this.date=new Date(n),isNaN(this.date)))throw TypeError('"date" "'+n+'" is not a valid date.');this.maxTimestampDelta=o}var r=e.prototype;return r.validate=function(e,r){try{try{if(Infinity!==this.maxTimestampDelta){var t=(this.date||new Date).getTime(),n=1e3*this.maxTimestampDelta,i=new Date(e.created).getTime();if(!(i>=t-n&&i<=t+n))throw new Error("The proof's created timestamp is out of range.")}return Promise.resolve({valid:!0})}catch(e){return Promise.resolve({valid:!1,error:e})}}catch(e){return Promise.reject(e)}},r.update=function(e,r){try{return e.proofPurpose=this.term,Promise.resolve(e)}catch(e){return Promise.reject(e)}},r.match=function(e){try{return Promise.resolve(e.proofPurpose===this.term)}catch(e){return Promise.reject(e)}},e}();const u=function(){function e(){}return e.prototype.then=function(r,t){const n=new e,i=this.s;if(i){const e=1&i?r:t;if(e){try{c(n,1,e(this.v))}catch(e){c(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?c(n,1,r?r(i):i):t?c(n,1,t(i)):c(n,2,i)}catch(e){c(n,2,e)}},n},e}();function c(e,r,t){if(!e.s){if(t instanceof u){if(!t.s)return void(t.o=c.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(c.bind(null,e,r),c.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}function l(e){return e instanceof u&&1&e.s}const d="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function f(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var h=require("security-context").constants,p={CREDENTIALS_CONTEXT_URL:"https://www.w3.org/2018/credentials/v2",CREDENTIALS_CONTEXT_V1_URL:require("credentials-context").constants.CREDENTIALS_CONTEXT_V1_URL,CREDENTIALS_CONTEXT_V2_URL:"https://www.w3.org/2018/credentials/v2",SECURITY_CONTEXT_URL:h.SECURITY_CONTEXT_V2_URL,SECURITY_CONTEXT_V1_URL:h.SECURITY_CONTEXT_V1_URL,SECURITY_CONTEXT_V2_URL:h.SECURITY_CONTEXT_V2_URL,SECURITY_PROOF_URL:"https://w3id.org/security#proof",SECURITY_SIGNATURE_URL:"https://w3id.org/security#signature"},v=require("jsonld"),m=function(e){function r(r){var t,n=void 0===r?{}:r,i=n.controller,o=n.maxTimestampDelta;if(t=e.call(this,{term:n.term,date:n.date,maxTimestampDelta:void 0===o?Infinity:o})||this,void 0!==i){if("object"!=typeof i)throw new TypeError('"controller" must be an object.');t.controller=i}return t}return a(r,e),r.prototype.validate=function(r,t){try{var n=this;return Promise.resolve(f((function(){return Promise.resolve(e.prototype.validate.call(n,r,t)).then((function(e){function r(r){var t=v.getValues(e.controller,n.term);if(e.valid=t.some((function(e){return e===a||"object"==typeof e&&e.id===a})),!e.valid)throw new Error('Verification method "'+i.id+'" not authorized by controller for proof purpose "'+n.term+'".');return e}if(!e.valid)throw e.error;var i=t.verificationMethod,o=t.documentLoader,a=i.id,s=function(){if(!n.controller){var r,t,s=i.controller,u=i.owner;if(s)if("object"==typeof s)t=s.id;else{if("string"!=typeof s)throw new TypeError('"controller" must be a string representing a URL.');t=s}else if(u)if("object"==typeof u)t=u.id;else{if("string"!=typeof u)throw new TypeError('"owner" must be a string representing a URL.');t=u}return Promise.resolve(v.frame(t,(r={"@context":p.SECURITY_CONTEXT_URL,id:t},r[n.term]={"@embed":"@never",id:a},r),{documentLoader:o,compactToRelative:!1})).then((function(r){var t=r["@graph"][0];e.controller=void 0===t?{}:t}))}e.controller=n.controller}();return s&&s.then?s.then(r):r()}))}),(function(e){return{valid:!1,error:e}})))}catch(e){return Promise.reject(e)}},r}(s),y=function(e){function r(r){var t=void 0===r?{}:r,n=t.term,i=t.maxTimestampDelta;return e.call(this,{term:void 0===n?"assertionMethod":n,controller:t.controller,date:t.date,maxTimestampDelta:void 0===i?Infinity:i})||this}return a(r,e),r}(m),w=require("jsonld"),E=function(e){function r(r){var t=void 0===r?{}:r;return e.call(this,{controller:t.controller,date:t.date,maxTimestampDelta:t.maxTimestampDelta})||this}return a(r,e),r.prototype.validate=function(r,t){var n=t.document,i=t.suite,o=t.verificationMethod,a=t.documentLoader,s=t.expansionMap;try{var u=this;return Promise.resolve(f((function(){return Promise.resolve(e.prototype.validate.call(u,r,{document:n,suite:i,verificationMethod:o,documentLoader:a,expansionMap:s})).then((function(e){if(!e.valid)throw e.error;var r=w.getValues(n,"https://www.w3.org/2018/credentials#issuer");if(!r||0===r.length)throw new Error("Credential issuer is required.");if(e.controller.id!==r[0].id)throw new Error("Credential issuer must match the verification method controller.");return{valid:!0}}))}),(function(e){return{valid:!1,error:e}})))}catch(e){return Promise.reject(e)}},r}(y),T=function(e){function r(r){var t,n=void 0===r?{}:r,i=n.term,o=n.challenge,a=n.domain,s=n.maxTimestampDelta;if(t=e.call(this,{term:void 0===i?"authentication":i,controller:n.controller,date:n.date,maxTimestampDelta:void 0===s?Infinity:s})||this,"string"!=typeof o)throw new TypeError('"challenge" must be a string.');if(void 0!==a&&"string"!=typeof a)throw new TypeError('"domain" must be a string.');return t.challenge=o,t.domain=a,t}a(r,e);var t=r.prototype;return t.validate=function(r,t){var n=t.verificationMethod,i=t.documentLoader,o=t.expansionMap;try{try{if(r.challenge!==this.challenge)throw new Error('The challenge is not as expected; challenge="'+r.challenge+'", expected="'+this.challenge+'"');if(void 0!==this.domain&&r.domain!==this.domain)throw new Error('The domain is not as expected; domain="'+r.domain+'", expected="'+this.domain+'"');return Promise.resolve(e.prototype.validate.call(this,r,{verificationMethod:n,documentLoader:i,expansionMap:o}))}catch(e){return Promise.resolve({valid:!1,error:e})}}catch(e){return Promise.reject(e)}},t.update=function(r,t){try{var n=this;return Promise.resolve(e.prototype.update.call(n,r,t)).then((function(e){return(r=e).challenge=n.challenge,void 0!==n.domain&&(r.domain=n.domain),r}))}catch(e){return Promise.reject(e)}},r}(m),g=new RegExp("^(\\d{4})-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])T([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9]|60)(\\.[0-9]+)?(Z|(\\+|-)([01][0-9]|2[0-3]):([0-5][0-9]))$","i");function b(e){return"string"==typeof e?e:"id"in e?e.id:void 0}var P=function(e,r){try{return"string"==typeof e?Promise.resolve():Promise.resolve(n.check(e,r)).then((function(r){if(!r.ok)throw new Error("credential is not valid JSON-LD: "+JSON.stringify(r.error,null,2));if(!e.type)throw new Error('"type" property is required.');if(!t.getValues(e,"type").includes("VerifiableCredential"))throw new Error('"type" must include `VerifiableCredential`.');if(!e.credentialSubject)throw new Error('"credentialSubject" property is required.');if(!e.issuer)throw new Error('"issuer" property is required.');if(t.getValues(e,"issuanceDate").length>1)throw new Error('"issuanceDate" property can only have one value.');if(!e.issuanceDate)throw new Error('"issuanceDate" property is required.');if("issuanceDate"in e&&!g.test(e.issuanceDate))throw new Error('"issuanceDate" must be a valid date: '+e.issuanceDate);if(t.getValues(e,"issuer").length>1)throw new Error('"issuer" property can only have one value.');if("issuer"in e){var n=b(e.issuer);if(!n)throw new Error('"issuer" id is required.');if(!n.includes(":"))throw new Error('"issuer" id must be a URL: '+n)}if("credentialStatus"in e){if(!e.credentialStatus.id)throw new Error('"credentialStatus" must include an id.');if(!e.credentialStatus.type)throw new Error('"credentialStatus" must include a type.')}if(t.getValues(e,"evidence").forEach((function(e){var r=b(e);if(r&&!r.includes(":"))throw new Error('"evidence" id must be a URL: '+e)})),"expirationDate"in e&&!g.test(e.expirationDate))throw new Error('"expirationDate" must be a valid date: '+e.expirationDate)}))}catch(e){return Promise.reject(e)}},_=function(e){if(!t.getValues(e,"type").includes("VerifiablePresentation"))throw new Error('"type" must include "VerifiablePresentation".')},S=function(e){try{var t=e.credential;try{if(!t)throw new TypeError('A "credential" property is required for verifying.');return function(e){try{var t=e.credential,n=e.checkStatus;return Promise.resolve(P(t,e.documentLoader)).then((function(){if(t.credentialStatus&&"function"!=typeof e.checkStatus)throw new TypeError('A "checkStatus" function must be given to verify credentials with "credentialStatus".');var i=e.purpose||new E({controller:e.controller});return Promise.resolve(r.verify(t,o({purpose:i},e))).then((function(r){if(!r.verified)return r;var i=function(){if(t.credentialStatus)return Promise.resolve(n(e)).then((function(e){r.statusResult=e,r.statusResult.verified||(r.verified=!1)}))}();return i&&i.then?i.then((function(){return r})):r}))}))}catch(e){return Promise.reject(e)}}(e)}catch(e){return Promise.resolve({verified:!1,results:[{credential:t,verified:!1,error:e}],error:e})}}catch(e){return Promise.reject(e)}},j=function(e){var r=void 0===e?{}:e,t=r.verifiableCredential,n=r.id,i=r.holder,o=r.documentLoader;try{var a=function(){return n&&(s.id=n),i&&(s.holder=i),_(s),s},s={"@context":[p.CREDENTIALS_CONTEXT_V1_URL],type:["VerifiablePresentation"]},f=function(){if(t){var e=function(){s.verifiableCredential=r},r=[].concat(t),n=function(e,r,t){if("function"==typeof e[d]){var n,i,o,a=e[d]();if(function e(t){try{for(;!(n=a.next()).done;)if((t=r(n.value))&&t.then){if(!l(t))return void t.then(e,o||(o=c.bind(null,i=new u,2)));t=t.v}i?c(i,1,t):i=t}catch(e){c(i||(i=new u),2,e)}}(),a.return){var s=function(e){try{n.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(s,(function(e){throw s(e)}));s()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var f=[],h=0;h<e.length;h++)f.push(e[h]);return function(e,r,t){var n,i,o=-1;return function t(a){try{for(;++o<e.length;)if((a=r(o))&&a.then){if(!l(a))return void a.then(t,i||(i=c.bind(null,n=new u,2)));a=a.v}n?c(n,1,a):n=a}catch(e){c(n||(n=new u),2,e)}}(),n}(f,(function(e){return r(f[e])}))}(r,(function(e){return Promise.resolve(P(e,o)).then((function(){}))}));return n&&n.then?n.then(e):e()}}();return Promise.resolve(f&&f.then?f.then(a):a())}catch(e){return Promise.reject(e)}},R={__proto__:null,issue:function(e){try{var t=e.credential,n=e.suite,i=e.documentLoader;if(!t)throw new TypeError('"credential" parameter is required for issuing.');return Promise.resolve(P(t,i)).then((function(){if(!i)throw new TypeError('"documentLoader" parameter is required for issuing.');if(!n)throw new TypeError('"suite" parameter is required for issuing.');if(!n.verificationMethod)throw new TypeError('"suite.verificationMethod" property is required.');var a=e.purpose||new E;return r.sign(t,o({purpose:a},e))}))}catch(e){return Promise.reject(e)}},verifyCredential:S,verify:function(e){try{if(!e.documentLoader)throw new TypeError('"documentLoader" parameter is required for verifying.');var n=e.presentation;try{if(!n)throw new TypeError('A "presentation" property is required for verifying.');return function(e){try{var n,i=function(){if(s)return{verified:u,results:[a],credentialResults:n};var t=e.controller,i=e.domain,c=e.challenge;if(!e.presentationPurpose&&!c)throw new Error('A "challenge" param is required for AuthenticationProofPurpose.');var l=e.presentationPurpose||new T({controller:t,domain:i,challenge:c});return Promise.resolve(r.verify(a,o({purpose:l},e))).then((function(e){return{presentationResult:e,verified:u&&e.verified,credentialResults:n,error:e.error}}))},a=e.presentation,s=e.unsignedPresentation;_(a);var u=!0,c=t.getValues(a,"verifiableCredential"),l=function(){if(c.length>0)return Promise.resolve(Promise.all(c.map((function(r){return S(o({credential:r},e))})))).then((function(e){(n=(n=e).map((function(e,r){return e.credentialId=c[r].id,e}))).every((function(e){return e.verified}))||(u=!1)}))}();return Promise.resolve(l&&l.then?l.then(i):i())}catch(e){return Promise.reject(e)}}(e)}catch(e){return Promise.resolve({verified:!1,results:[{presentation:n,verified:!1,error:e}],error:e})}}catch(e){return Promise.reject(e)}},createPresentation:j,signPresentation:function(e){void 0===e&&(e={});try{var t=e.presentation,n=e.documentLoader,i=e.purpose||new T({domain:e.domain,challenge:e.challenge});if(!n)throw new TypeError('"documentLoader" parameter is required for issuing.');return Promise.resolve(r.sign(t,o({purpose:i},e)))}catch(e){return Promise.reject(e)}}};exports.jwt={__proto__:null,issue:function(e,r,t){try{if(void 0===e.issuer)throw new Error('Verifiable Credentials require an "issuer".');if(void 0===e.credentialSubject||void 0===e.credentialSubject.id)throw new Error('Verifiable Credentials require an "subject".');var n=(a=e.issuer,Array.isArray(a)||"object"!=typeof a&&"function"!=typeof a||null===a?e.issuer:e.issuer.id),o=e.credentialSubject.id;return Promise.resolve(P(e,t)).then((function(){var t={iss:n,sub:o,vc:e};return e.id&&(t.jti=e.id),e.issuanceDate&&(t.nbf=i(e.issuanceDate).unix()),e.expirationDate&&(t.exp=i(e.expirationDate).unix()),r.sign(t,{})}))}catch(e){return Promise.reject(e)}var a},createPresentation:function(e,r,t){try{return Promise.resolve(j({verifiableCredential:e,holder:r,id:t})).then((function(e){var t={iss:r,sub:r,vp:e};return e.id&&(t.jti=e.id),t}))}catch(e){return Promise.reject(e)}},provePresentation:function(e,r,t){return r.challenge&&(e.nonce=r.challenge),r.domain&&(e.aud=r.domain),t.sign(e,{})},verify:function(e,r){return r.verify(e)}},exports.ld=R;
//# sourceMappingURL=vc.js.cjs.production.min.js.map
