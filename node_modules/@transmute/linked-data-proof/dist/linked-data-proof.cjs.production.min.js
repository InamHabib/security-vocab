"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,r=(e=require("jsonld"))&&"object"==typeof e&&"default"in e?e.default:e,t=require("serialize-error");const o=function(){function e(){}return e.prototype.then=function(r,t){const o=new e,i=this.s;if(i){const e=1&i?r:t;if(e){try{n(o,1,e(this.v))}catch(e){n(o,2,e)}return o}return this}return this.o=function(e){try{const i=e.v;1&e.s?n(o,1,r?r(i):i):t?n(o,1,t(i)):n(o,2,i)}catch(e){n(o,2,e)}},o},e}();function n(e,r,t){if(!e.s){if(t instanceof o){if(!t.s)return void(t.o=n.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(n.bind(null,e,r),n.bind(null,e,2));e.s=r,e.v=t;const i=e.o;i&&i(e)}}function i(e){return e instanceof o&&1&e.s}const u="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function c(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}function a(){return(a=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,r){return(f=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function p(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function d(e,r,t){return(d=p()?Reflect.construct:function(e,r,t){var o=[null];o.push.apply(o,r);var n=new(Function.bind.apply(e,o));return t&&f(n,t.prototype),n}).apply(null,arguments)}function l(e){var r="function"==typeof Map?new Map:void 0;return(l=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return d(e,arguments,s(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),f(t,e)})(e)}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var m=require("security-context").constants,h={SECURITY_CONTEXT_URL:m.SECURITY_CONTEXT_V2_URL,SECURITY_CONTEXT_V1_URL:m.SECURITY_CONTEXT_V1_URL,SECURITY_CONTEXT_V2_URL:m.SECURITY_CONTEXT_V2_URL,SECURITY_CONTEXT_V3_URL:"https://w3id.org/security/v3-unstable",SECURITY_PROOF_URL:"https://w3id.org/security#proof",SECURITY_SIGNATURE_URL:"https://w3id.org/security#signature"},v=function(e){if(e.unmappedProperty)throw new Error('The property "'+e.unmappedProperty+'" in the input was not defined in the context.')},y=function(){function e(){var e=this,s=this;this._getProofs=function(e){var t=e.document,o=e.legacy,n=e.documentLoader,i=e.expansionMap,u=e.compactProof;try{var c,s=function(){if(c=r.getValues(t,f),delete t[f],0===c.length)throw new Error("No matching proofs found in the given document.");return{proofSet:c=c.map((function(e){return a({"@context":h.SECURITY_CONTEXT_URL},e)})),document:t}},f=o?"signature":"proof",p=function(){if(u)return Promise.resolve(r.compact(t,h.SECURITY_CONTEXT_URL,{documentLoader:n,expansionMap:i,compactToRelative:!1})).then((function(e){t=e}))}();return Promise.resolve(p&&p.then?p.then(s):s())}catch(e){return Promise.reject(e)}},this._verify=function(r){var t=r.document,c=r.suites,s=r.proofSet,f=r.purpose,p=r.documentLoader,d=r.expansionMap,l=r.compactProof;try{return Promise.resolve(Promise.all(s.map((function(e){return f.match(e,{document:t,documentLoader:p,expansionMap:d})})))).then((function(r){var m=s.filter((function(e,t){return r[t]}));return 0===m.length?[]:Promise.resolve(Promise.all(m.map((function(e){try{var r=!1;return Promise.resolve(function(e,r,t){if("function"==typeof e[u]){var c,a,s,f=e[u]();if(function e(u){try{for(;!((c=f.next()).done||t&&t());)if((u=r(c.value))&&u.then){if(!i(u))return void u.then(e,s||(s=n.bind(null,a=new o,2)));u=u.v}a?n(a,1,u):a=u}catch(e){n(a||(a=new o),2,e)}}(),f.return){var p=function(e){try{c.done||f.return()}catch(e){}return e};if(a&&a.then)return a.then(p,(function(e){throw p(e)}));p()}return a}if(!("length"in e))throw new TypeError("Object is not iterable");for(var d=[],l=0;l<e.length;l++)d.push(e[l]);return function(e,r,t){var u,c,a=-1;return function s(f){try{for(;++a<e.length&&(!t||!t());)if((f=r(a))&&f.then){if(!i(f))return void f.then(s,c||(c=n.bind(null,u=new o,2)));f=f.v}u?n(u,1,f):u=f}catch(e){n(u||(u=new o),2,e)}}(),u}(d,(function(e){return r(d[e])}),t)}(c,(function(o){return Promise.resolve(o.matchProof({proof:e,document:t,documentLoader:p,expansionMap:d})).then((function(n){if(n)return r=!0,o.verifyProof({proof:e,document:t,purpose:f,documentLoader:p,expansionMap:d,compactProof:l}).catch((function(e){return{verified:!1,error:e}}))}))}),(function(){return r})))}catch(e){return Promise.reject(e)}})))).then((function(r){return r.map((function(r,t){return r?(r.error&&e._addToJSON(r.error),a({proof:m[t]},r)):null})).filter((function(e){return e}))}))}))}catch(e){return Promise.reject(e)}},this._addToJSON=function(e){Object.defineProperty(e,"toJSON",{value:function(){return t.serializeError(this)},configurable:!0,writable:!0})},this.verify=function(e,r){var t=void 0===r?{}:r,o=t.suite,n=t.purpose,i=t.documentLoader,u=t.expansionMap,f=t.compactProof,p=void 0===f||f;try{if(!o)throw new TypeError('"options.suite" is required.');if(!n)throw new TypeError('"options.purpose" is required.');var d=Array.isArray(o)?o:[o];if(0===d.length)throw new TypeError("At least one suite is required.");var l=d.some((function(e){return e.legacy}));if(l)throw new TypeError("Legacy suites are no longer supported.");if(!i)throw new TypeError('"options.documentLoader" is required.');return!1!==u&&(u=v),Promise.resolve(c((function(){function r(){return Promise.resolve(s._getProofs({document:e,legacy:l,documentLoader:i,expansionMap:u,compactProof:p})).then((function(r){return e=r.document,Promise.resolve(s._verify({document:e,suites:d,proofSet:r.proofSet,purpose:n,documentLoader:i,expansionMap:u,compactProof:p})).then((function(e){if(0===e.length)throw new Error("Could not verify any proofs; no proofs matched the required suite and purpose.");var r=e.some((function(e){return e.verified}));if(!r){var t,o=(t=[]).concat.apply(t,e.filter((function(e){return e.error})).map((function(e){return e.error}))),n={verified:r,results:e};return o.length>0&&(n.error=o),n}return{verified:r,results:e}}))}))}var t=function(){if("string"==typeof e)return Promise.resolve(i(e)).then((function(r){e=r}));e=a({},e)}();return t&&t.then?t.then(r):r()}),(function(e){return s._addToJSON(e),{verified:!1,error:e}})))}catch(e){return Promise.reject(e)}}}return e.prototype.add=function(e,t){var o=void 0===t?{compactProof:!0}:t,n=o.suite,i=o.purpose,u=o.documentLoader,c=o.expansionMap,s=o.compactProof,f=void 0===s||s;try{var p=function(){function t(){var t=n.legacy?"signature":"proof";return delete o[t],Promise.resolve(n.createProof({document:o,purpose:i,documentLoader:u,expansionMap:c,compactProof:f})).then((function(o){var i=function(){var i,a,s;if(f)return n.legacy?((a={})[h.SECURITY_SIGNATURE_URL]=o,i=a):((s={})[h.SECURITY_PROOF_URL]={"@graph":o},i=s),Promise.resolve(function(e){var t=e.document,o=e.documentLoader,n=e.expansionMap;try{var i=r.getValues(t,"@context");return Promise.resolve(r.compact({"@type":"_:b0"},i,{documentLoader:o,expansionMap:n})).then((function(e){delete e["@context"];var u=Object.keys(e)[0],c={"@context":i};return c["@type"]=r.getValues(t,"@type").concat(r.getValues(t,u)),Promise.resolve(r.expand(c,{documentLoader:o,expansionMap:n})).then((function(e){return{types:r.getValues(e[0]||{},"@type"),alias:u}}))}))}catch(e){return Promise.reject(e)}}({document:e,documentLoader:u,expansionMap:c})).then((function(t){var o=t.alias;i["@type"]=t.types;var n=r.getValues(e,"@context");return Promise.resolve(r.compact(i,n,{documentLoader:u,expansionMap:c,compactToRelative:!1})).then((function(t){delete t[o],delete t["@context"];var n=Object.keys(t)[0];r.addValue(e,n,t[n])}))}));delete o["@context"],r.addValue(e,t,o)}();return i&&i.then?i.then((function(){return e})):e}))}var o,s=function(){if(f)return Promise.resolve(r.compact(e,h.SECURITY_CONTEXT_URL,{documentLoader:u,expansionMap:c,compactToRelative:!1})).then((function(e){o=e}));o=a({},e)}();return s&&s.then?s.then(t):t()};if(!n)throw new TypeError('"options.suite" is required.');if(!u)throw new TypeError('"options.documentLoader" is required.');if(!i)throw new TypeError('"options.purpose" is required.');if(n.legacy)throw new TypeError("Legacy suites are no longer supported.");!1!==c&&(c=v);var d=function(){if("string"==typeof e)return Promise.resolve(u(e)).then((function(r){e=r}))}();return Promise.resolve(d&&d.then?d.then(p):p())}catch(e){return Promise.reject(e)}},e}(),P=function(e){var r,t;function o(r){var t;return(t=e.call(this,"Verification error(s).")||this).name="VerificationError",t.errors=[].concat(r),t}return t=e,(r=o).prototype=Object.create(t.prototype),r.prototype.constructor=r,r.__proto__=t,o}(l(Error));exports.sign=function(e,r){var t=void 0===r?{compactProof:!0}:r,o=t.suite,n=t.purpose,i=t.documentLoader,u=t.expansionMap,a=t.compactProof;try{return Promise.resolve(c((function(){return Promise.resolve((new y).add(e,{suite:o,purpose:n,documentLoader:i,expansionMap:u,compactProof:a}))}),(function(e){if(!i&&"jsonld.InvalidUrl"===e.name){var r=new Error('A URL "'+e.details.url+'" could not be fetched;you need to pass "documentLoader" or resolve the URL before calling "sign".');throw r.cause=e,r}throw e})))}catch(e){return Promise.reject(e)}},exports.verify=function(e,r){var t=void 0===r?{}:r,o=t.suite,n=t.purpose,i=t.documentLoader,u=t.expansionMap,c=t.compactProof;try{return Promise.resolve((new y).verify(e,{suite:o,purpose:n,documentLoader:i,expansionMap:u,compactProof:c})).then((function(e){var r=e.error;if(r)if(i||"jsonld.InvalidUrl"!==r.name)e.error=new P(r);else{var t=new Error('A URL "'+r.details.url+'" could not be fetched; you need to pass "documentLoader" or resolve the URL before calling "verify".');e.error=new P(t)}return e}))}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=linked-data-proof.cjs.production.min.js.map
